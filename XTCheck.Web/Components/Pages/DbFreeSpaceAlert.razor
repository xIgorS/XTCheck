@page "/dbfreespacealert"
@inject IDbSizeStatsApiClient ApiClient
@rendermode InteractiveServer

<PageTitle>Database Free Space Alerts</PageTitle>

<div class="page-header">
    <h1 class="page-title">Database Free Space Alerts</h1>
    <RadzenButton Text="Reload Alerts" Icon="refresh" Click="LoadAlerts" Disabled="isLoading" />
</div>

@if (isLoading)
{
    <RadzenProgressBarCircular ShowValue="true" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large">
        <Template>Loading alerts...</Template>
    </RadzenProgressBarCircular>
}
else if (errorMessage != null)
{
    <RadzenAlert AlertStyle="AlertStyle.Danger" Shade="Shade.Light" AllowClose="false">
        @errorMessage
    </RadzenAlert>
    <RadzenButton Text="Retry" Click="LoadAlerts" Icon="refresh" Class="mt-2" />
}
else
{
    @if (!alerts.Any())
    {
        <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Light" AllowClose="false">
            No alerts returned from the server.
        </RadzenAlert>
    }
    else
    {
        <div class="row section">
            <div class="col-12">
                <RadzenCard Class="card-surface">
                    <h4 class="section-title">FileGroup Capacity</h4>
                    <ApexChart TItem="DbSizeAlertStats"
                               Options="fileGroupChartOptions"
                               Height="350">
                        <ApexPointSeries TItem="DbSizeAlertStats"
                                         Items="alerts"
                                         SeriesType="SeriesType.Bar"
                                         Name="Used (MB)"
                                         XValue="alert => GetAlertLabel(alert)"
                                         YValue="alert => alert.UsedDBSpaceMB" />
                        <ApexPointSeries TItem="DbSizeAlertStats"
                                         Items="alerts"
                                         SeriesType="SeriesType.Bar"
                                         Name="Free (MB)"
                                         XValue="alert => GetAlertLabel(alert)"
                                         YValue="alert => alert.FreeDBSpaceMB" />
                    </ApexChart>
                </RadzenCard>
            </div>
        </div>

        <div class="row section">
            <div class="col-12">
                <RadzenCard Class="card-surface">
                    <h4 class="section-title">Alert Details</h4>
                    <p class="text-muted mb-2">Showing alerts for all databases and filegroups with potential space issues.</p>
                    <div class="table-responsive">
                        <QuickGrid Items="@alerts.AsQueryable()" TItem="DbSizeAlertStats" Class="table table-striped table-hover align-middle table-sm table-compact">
                            <PropertyColumn Title="FileGroup" Property="@(alert => alert.FileGroup)" Sortable="true" IsDefaultSortColumn="true" />
                            <TemplateColumn Title="Allocated (MB)" SortBy="@(GridSort<DbSizeAlertStats>.ByAscending(x => x.AllocatedDBSpaceMB))">
                                <span class="text-end d-block">@context.AllocatedDBSpaceMB.ToString("N2")</span>
                            </TemplateColumn>
                            <TemplateColumn Title="Used (MB)" SortBy="@(GridSort<DbSizeAlertStats>.ByAscending(x => x.UsedDBSpaceMB))">
                                <span class="text-end d-block">@context.UsedDBSpaceMB.ToString("N2")</span>
                            </TemplateColumn>
                            <TemplateColumn Title="Free (MB)" SortBy="@(GridSort<DbSizeAlertStats>.ByAscending(x => x.FreeDBSpaceMB))">
                                <span class="text-end d-block">@context.FreeDBSpaceMB.ToString("N2")</span>
                            </TemplateColumn>
                            <TemplateColumn Title="Drive Free (MB)" SortBy="@(GridSort<DbSizeAlertStats>.ByAscending(x => x.FreeDriveMB))">
                                <span class="text-end d-block">@context.FreeDriveMB.ToString("N2")</span>
                            </TemplateColumn>
                            <PropertyColumn Title="Partition Size (MB)" Property="@(alert => alert.PartSizeMB)" Sortable="true" />
                            <TemplateColumn Title="Total Free (MB)" SortBy="@(GridSort<DbSizeAlertStats>.ByAscending(x => x.TotalFreeSpaceMB))">
                                <span class="text-end d-block">@context.TotalFreeSpaceMB.ToString("N2")</span>
                            </TemplateColumn>
                            <TemplateColumn Title="Autogrow" SortBy="@(GridSort<DbSizeAlertStats>.ByAscending(x => x.AutogrowEnabled))">
                                @if (context.AutogrowEnabled)
                                {
                                    <RadzenBadge Text="Enabled" Class="badge-pill status-ok" />
                                }
                                else
                                {
                                    <RadzenBadge Text="Disabled" Class="badge-pill status-critical" />
                                }
                            </TemplateColumn>
                            <TemplateColumn Title="Severity" SortBy="@(GridSort<DbSizeAlertStats>.ByAscending(x => x.AlertLevel))">
                                <span class="@GetSeverityCellClass(context.AlertLevel)">@NormalizeSeverity(context.AlertLevel)</span>
                            </TemplateColumn>
                        </QuickGrid>
                    </div>
                </RadzenCard>
            </div>
        </div>
    }
}

@code {
    private List<DbSizeAlertStats> alerts = new();
    private bool isLoading = true;
    private string? errorMessage;


    private readonly ApexChartOptions<DbSizeAlertStats> fileGroupChartOptions = new()
    {
        Chart = new Chart { Type = ChartType.Bar, Stacked = true },
        Colors = new List<string> { "#F44336", "#4CAF50" },
        PlotOptions = new PlotOptions
        {
            Bar = new PlotOptionsBar { Horizontal = true }
        },
        Legend = new Legend { Position = ApexCharts.LegendPosition.Top },
        Xaxis = new XAxis { Title = new AxisTitle { Text = "FileGroup" } },
        Yaxis = new List<YAxis>
        {
            new()
            {
                Title = new AxisTitle { Text = "Size (MB)" }
            }
        }
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadAlerts();
    }

    private async Task LoadAlerts()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            var result = await ApiClient.GetDbFreeSpaceAlertsAsync();
            alerts = result.ToList();

        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load alerts: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }


    private string NormalizeSeverity(string? alertLevel)
    {
        if (string.IsNullOrWhiteSpace(alertLevel))
        {
            return "Unspecified";
        }

        if (alertLevel.Equals("critical", StringComparison.OrdinalIgnoreCase))
        {
            return "Critical";
        }

        if (alertLevel.Equals("warning", StringComparison.OrdinalIgnoreCase))
        {
            return "Warning";
        }

        if (alertLevel.Equals("ok", StringComparison.OrdinalIgnoreCase))
        {
            return "OK";
        }

        return alertLevel;
    }

    private string GetAlertLabel(DbSizeAlertStats alert)
        => $"{alert.DatabaseName} - {alert.FileGroup}";

    private string GetSeverityBadgeClass(string alertLevel)
    {
        var severity = NormalizeSeverity(alertLevel);
        return severity switch
        {
            "Critical" => "badge-pill status-critical",
            "Warning" => "badge-pill status-warning",
            "OK" => "badge-pill status-ok",
            _ => "badge-pill status-neutral"
        };
    }

    private string GetSeverityCellClass(string alertLevel)
    {
        var severity = NormalizeSeverity(alertLevel);
        return severity switch
        {
            "Critical" => "severity-cell severity-critical",
            "Warning" => "severity-cell severity-warning",
            "OK" => "severity-cell severity-ok",
            _ => "severity-cell"
        };
    }

}
