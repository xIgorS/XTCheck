@page "/dbsizestats"
@rendermode InteractiveServer


<PageTitle>Database Size Statistics</PageTitle>

<h1 class="page-title">Database Size Statistics</h1>

@if (isLoading)
{
    <RadzenProgressBarCircular ShowValue="true" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large">
        <Template>Loading...</Template>
    </RadzenProgressBarCircular>
}
else if (errorMessage != null)
{
    <RadzenAlert AlertStyle="AlertStyle.Danger" Shade="Shade.Light" AllowClose="false">
        @errorMessage
    </RadzenAlert>
    <RadzenButton Text="Retry" Click="LoadData" Class="mt-2" />
}
else
{
    <div class="row g-3">
        <div class="col-md-6">
            <RadzenCard Class="card-surface">
                <h4 class="section-title">Select Database</h4>
                <RadzenDropDown @bind-Value="selectedDatabase" 
                                Data="@databases" 
                                TextProperty="DatabaseName" 
                                ValueProperty="DatabaseName"
                                Placeholder="Select a database..."
                                Class="w-100"
                                Change="OnDatabaseSelected" />
            </RadzenCard>
        </div>
        <div class="col-md-6">
            <RadzenCard Class="card-surface">
                <RadzenButton Text="Refresh Data" Click="LoadData" Icon="refresh" />
            </RadzenCard>
        </div>
    </div>

    <div class="row section g-3">
        @* Donut Chart for Selected Database - ApexCharts *@
        <div class="col-md-6">
            <RadzenCard Class="card-surface">
                <h4 class="section-title">@(selectedDatabase ?? "All Databases") - Space Usage</h4>
                @if (selectedDatabaseData != null)
                {
                    <div class="text-center mb-2">
                        <strong>Total Allocated: @selectedDatabaseData.TotalAllocatedMB.ToString("N0") MB</strong>
                    </div>
                    <ApexChart TItem="ChartDataItem"
                               Title=""
                               Options="dbSpaceChartOptions"
                               Height="350">
                        <ApexPointSeries TItem="ChartDataItem"
                                         Items="dbSpaceChartData"
                                         SeriesType="SeriesType.Donut"
                                         XValue="e => e.Label"
                                         YValue="e => e.Value"
                                         OrderBy="e => e.X" />
                    </ApexChart>
                }
                else
                {
                    <p>Select a database to view details</p>
                }
            </RadzenCard>
        </div>

        @* Stacked Bar Chart for All Databases - ApexCharts *@
        <div class="col-md-6">
            <RadzenCard Class="card-surface">
                <h4 class="section-title">All Databases Comparison</h4>
                <ApexChart TItem="DatabaseSizeAggregate"
                           Title=""
                           Options="allDbChartOptions"
                           Height="350">
                    <ApexPointSeries TItem="DatabaseSizeAggregate"
                                     Items="databases"
                                     SeriesType="SeriesType.Bar"
                                     Name="Used (MB)"
                                     XValue="e => e.DatabaseName"
                                     YValue="e => e.TotalUsedMB" />
                    <ApexPointSeries TItem="DatabaseSizeAggregate"
                                     Items="databases"
                                     SeriesType="SeriesType.Bar"
                                     Name="Free (MB)"
                                     XValue="e => e.DatabaseName"
                                     YValue="e => e.TotalFreeMB" />
                </ApexChart>
            </RadzenCard>
        </div>
    </div>

    @* Data Grid with Details - Keep Radzen *@
    <div class="row section">
        <div class="col-12">
            <RadzenCard Class="card-surface">
                <h4 class="section-title">Database Details</h4>
                <div class="table-responsive">
                    <QuickGrid Items="@databases.AsQueryable()" TItem="DatabaseSizeAggregate" Class="table table-striped table-hover align-middle table-sm">
                        <PropertyColumn Title="Instance" Property="@(db => db.InstanceName)" Sortable="true" />
                        <PropertyColumn Title="Database" Property="@(db => db.DatabaseName)" Sortable="true" IsDefaultSortColumn="true" />
                        <TemplateColumn Title="Allocated (MB)" SortBy="@(GridSort<DatabaseSizeAggregate>.ByAscending(x => x.TotalAllocatedMB))">
                            <span class="text-end d-block">@context.TotalAllocatedMB.ToString("N0")</span>
                        </TemplateColumn>
                        <TemplateColumn Title="Used (MB)" SortBy="@(GridSort<DatabaseSizeAggregate>.ByAscending(x => x.TotalUsedMB))">
                            <span class="text-end d-block">@context.TotalUsedMB.ToString("N0")</span>
                        </TemplateColumn>
                        <TemplateColumn Title="Free (MB)" SortBy="@(GridSort<DatabaseSizeAggregate>.ByAscending(x => x.TotalFreeMB))">
                            <span class="text-end d-block">@context.TotalFreeMB.ToString("N0")</span>
                        </TemplateColumn>
                        <TemplateColumn Title="Used %" SortBy="@(GridSort<DatabaseSizeAggregate>.ByAscending(x => x.UsedPercent))">
                            <RadzenProgressBar Value="@context.UsedPercent" Max="100" Style="height: 20px;" 
                                               ProgressBarStyle="@(context.UsedPercent > 90 ? ProgressBarStyle.Danger : context.UsedPercent > 75 ? ProgressBarStyle.Warning : ProgressBarStyle.Success)" />
                        </TemplateColumn>
                    </QuickGrid>
                </div>
            </RadzenCard>
        </div>
    </div>

    @* FileGroup Statistics for Selected Database *@
    @if (selectedDatabase != null && fileGroups.Any())
    {
        <div class="row section g-3">
            <div class="col-12">
                <RadzenCard Class="card-surface">
                    <h4 class="section-title">@selectedDatabase - FileGroup Breakdown</h4>
                    <ApexChart TItem="FileGroupAggregate"
                               Title=""
                               Options="fileGroupChartOptions"
                               Height="300">
                        <ApexPointSeries TItem="FileGroupAggregate"
                                         Items="fileGroups"
                                         SeriesType="SeriesType.Bar"
                                         Name="Used (MB)"
                                         XValue="e => e.FileGroup"
                                         YValue="e => e.UsedMB" />
                        <ApexPointSeries TItem="FileGroupAggregate"
                                         Items="fileGroups"
                                         SeriesType="SeriesType.Bar"
                                         Name="Free (MB)"
                                         XValue="e => e.FileGroup"
                                         YValue="e => e.FreeMB" />
                    </ApexChart>
                </RadzenCard>
            </div>
        </div>
        <div class="row section g-3">
            <div class="col-12">
                <RadzenCard Class="card-surface">
                    <h4 class="section-title">FileGroup Details</h4>
                    <div class="table-responsive">
                        <QuickGrid Items="@fileGroups.AsQueryable()" TItem="FileGroupAggregate" Class="table table-striped table-hover align-middle table-sm">
                            <PropertyColumn Title="FileGroup" Property="@(fg => fg.FileGroup)" Sortable="true" IsDefaultSortColumn="true" />
                            <PropertyColumn Title="Type" Property="@(fg => fg.FileType)" Sortable="true" />
                            <PropertyColumn Title="Files" Property="@(fg => fg.FileCount)" Sortable="true" />
                            <TemplateColumn Title="Allocated" SortBy="@(GridSort<FileGroupAggregate>.ByAscending(x => x.AllocatedMB))">
                                <span class="text-end d-block">@context.AllocatedMB.ToString("N0")</span>
                            </TemplateColumn>
                            <TemplateColumn Title="Used" SortBy="@(GridSort<FileGroupAggregate>.ByAscending(x => x.UsedMB))">
                                <span class="text-end d-block">@context.UsedMB.ToString("N0")</span>
                            </TemplateColumn>
                            <TemplateColumn Title="Free" SortBy="@(GridSort<FileGroupAggregate>.ByAscending(x => x.FreeMB))">
                                <span class="text-end d-block">@context.FreeMB.ToString("N0")</span>
                            </TemplateColumn>
                            <TemplateColumn Title="Used %" SortBy="@(GridSort<FileGroupAggregate>.ByAscending(x => x.UsedPercent))">
                                <RadzenProgressBar Value="@context.UsedPercent" Max="100" Style="height: 18px;" 
                                                   ProgressBarStyle="@(context.UsedPercent > 90 ? ProgressBarStyle.Danger : context.UsedPercent > 75 ? ProgressBarStyle.Warning : ProgressBarStyle.Success)" />
                            </TemplateColumn>
                        </QuickGrid>
                    </div>
                </RadzenCard>
            </div>
        </div>
    }

    @* Disk Space Information *@
    @if (diskSpaceInfo.Any())
    {
        <div class="row section g-3">
            <div class="col-12">
                <RadzenCard Class="card-surface">
                    <h4 class="section-title">Disk Space Details</h4>
                    <div class="table-responsive">
                        <QuickGrid Items="@diskSpaceInfo.AsQueryable()" TItem="DiskSpaceInfo" Class="table table-striped table-hover align-middle table-sm">
                            <PropertyColumn Title="Drive" Property="@(disk => disk.DrivePath)" Sortable="true" IsDefaultSortColumn="true" />
                            <TemplateColumn Title="Total (MB)" SortBy="@(GridSort<DiskSpaceInfo>.ByAscending(x => x.TotalDriveMB))">
                                <span class="text-end d-block">@context.TotalDriveMB.ToString("N0")</span>
                            </TemplateColumn>
                            <TemplateColumn Title="Used (MB)" SortBy="@(GridSort<DiskSpaceInfo>.ByAscending(x => x.UsedDriveMB))">
                                <span class="text-end d-block">@context.UsedDriveMB.ToString("N0")</span>
                            </TemplateColumn>
                            <TemplateColumn Title="Free (MB)" SortBy="@(GridSort<DiskSpaceInfo>.ByAscending(x => x.FreeDriveMB))">
                                <span class="text-end d-block">@context.FreeDriveMB.ToString("N0")</span>
                            </TemplateColumn>
                            <TemplateColumn Title="Used %" SortBy="@(GridSort<DiskSpaceInfo>.ByAscending(x => x.UsedPercent))">
                                <RadzenProgressBar Value="@context.UsedPercent" Max="100" Style="height: 20px;" 
                                                   ProgressBarStyle="@(context.UsedPercent > 90 ? ProgressBarStyle.Danger : context.UsedPercent > 80 ? ProgressBarStyle.Warning : ProgressBarStyle.Success)" 
                                                   ShowValue="true" />
                            </TemplateColumn>
                        </QuickGrid>
                    </div>
                </RadzenCard>
            </div>
        </div>
    }
}
